---
title: "FRNL CS 2.10"
output: html_notebook
---

# Evaluation of fodder beet + catch crop rotation (FRNL)

Table 1. Summary of observed and simulated data
```{r, echo=FALSE, include=FALSE}
library(dplyr) # data analysis
library(ggplot2)
library(lubridate) # taking care of dates
library (hydroGOF) # library with heaps of functions that do stats we need
library(xtable)
library(knitr)
library(tidyr)
library(RSQLite)
library(here)
library(xlsx)
```

```{r, echo=FALSE}
rootPath <- "K:/Rainshelter/Fodderbeet 2016-2017/Analysis"
```

```{r, echo=FALSE}
# read simulated data
simData <- read.csv(paste0(rootPath,"/SimulatedDataWorked.csv"), header = TRUE)
str(simData)
```


```{r, echo=FALSE}

# Define factors
factorindex <- c("Nit","Irr", "CropOper.Script.CropSown", "SimName")
simData[,factorindex] <- as.data.frame(sapply(simData[,factorindex],as.factor))

# Tidy up sim data
simData_work <- simData %>%
  mutate(Nit=factor(Nit)) %>%
  mutate(Clock.Today=as.Date(ymd_hms(Clock.Today))) %>%
  mutate(Irr = factor(Irr, levels=c("Nil", "Full"), labels=c("Dry","Irrig")))  %>%
  mutate() %>%
  dplyr::select(-Zone,-SimulationID,-SimName) %>%
  tidyr::gather("VarName","SimValue",FodderBeet.Phenology.Stage:N_leaching) %>%
  mutate(VarName = factor(VarName)) %>%
  rowwise() %>%
  mutate(SimValue = ifelse(grepl('.NConc', VarName),SimValue*100,SimValue))

summary(simData_work)
```


```{r, echo=FALSE, include=TRUE}
str(simData_work)
```

```{r, echo=FALSE, include=TRUE}
# read observed data
obsData <- read.csv(paste0(rootPath,"/ObservedDataWorked.csv"), header = TRUE)
summary(obsData)
```


```{r, echo=FALSE}
# Average observed data to fit APSIM-X

obsData_av <- obsData %>%
  mutate(Nit=factor(Nit)) %>%
  mutate(Clock.Today=ymd(Clock.Today)) %>%
  dplyr::select(-Plot,-Rep,-SimulationName,-Code) %>%
  group_by(Clock.Today,Irr,Nit) %>%
  summarise_all(funs(mean)) %>%
  tidyr::gather("VarName","ObsValue",FodderBeet.Leaf.LAI:FodderBeet.StorageRoot.Nconc) %>%
  mutate(VarName = factor(VarName))%>%
  ungroup()

summary(obsData_av)
```

```{r, echo=FALSE, include=TRUE}

obsData_av <- read.csv(paste0(pathMaster,"/Observed.xlsx") )

str(obsData_av)
```

```{r, echo=FALSE, include=TRUE}
str(simData_work)
```

```{r, echo=FALSE}
mergedDF <- data.frame() # empty data frame to do stuff
mergedDF <- merge(simData_work, obsData_av, by=c("Clock.Today","Irr","Nit","VarName"))

mergedDF %>%
gather("VarType","VarValue",ObsValue:SimValue) %>%
mutate(VarType=factor(VarType))%>%
spread(VarName,VarValue) %>%
dplyr::select(-Clock.Today) %>%
summary() 
```

# Model evaluation

## 1. Simulated x Observed graphs

- Black line is x=y (1:1 line)
- Colour lines are linear fits for dryland and irrigated crops

```{r, fig.width=12, fig.height=12, echo=FALSE}

mergedDF %>%
  ggplot(aes(x=ObsValue,y=SimValue)) +
  geom_point(alpha=0.5, aes(colour=Irr,shape=Nit), size=2) +
  geom_abline(intercept = 0, slope = 1, size=1.5) +
  facet_wrap(CropOper.Script.CropSown~VarName, ncol=2, scales='free')+
  geom_smooth(method = "lm", se = TRUE,  aes(fill = Irr, linetype=Irr, colour=Irr), alpha=0.1) +
  coord_fixed(ratio = 1) +
  ylab("Simulated value") +
  xlab("Measured value")


```

## 2. Basic statistics

Selection of stats indexes to use, at the moment we're following the refs:

(i) Moriasi, D.N., Arnold, J.G., Van Liew, M.W., Bingner, R.L., R.D., H., Veith, T.L., 2007. Model evaluation guidelines for systematic quantification of accuracy in watershed simulations. Transactions of the ASABE 50, 885-900

(ii) Gauch Jr, H.G., Hwang, J.T.G., Fick, G.W., 2003. Model evaluation by comparison of model-based predictions and measured values. Agron. J. 95, 1442-1446

```{r, include=FALSE, echo=FALSE}

# Create stats function
gauchStats <- function(sim, meas) {

  n_s <- length(sim)
  n_m <- length(meas)
  model <- lm(meas~sim)
  sim_sq <- sum((sim - mean(sim))^2)
  mes_sq <- sum((meas - mean(meas))^2)
  r2 <- summary(model)$r.squared
  slope <- model$coefficients[[2]]

  sb <- (sum(mean(meas)) - sum(mean(sim)))^2
  nu <- (1-slope)^2 * (sim_sq/n_s)
  lc <- (1-r2) * (mes_sq/n_m)
  msd <- sb+nu+lc

  sb_r <- round((sb/msd)*100,1)
  nu_r <- round((nu/msd)*100,1)
  lc_r <- round((lc/msd)*100,1)

  msd_r <- sb_r+nu_r+lc_r

  # select which variables to output
  out <- c(sb_r,nu_r,lc_r, msd_r, round(r2*100,1))

  return(out)

}
```



```{r}
# Embed gauch stats in another function 

doStats <-  function (x) {
    library(dplyr)
    x %>% dplyr::summarise(
    n = n(),
    meanObsValue = mean(ObsValue),
    r2 = gauchStats(SimValue,ObsValue)[5],
    rmse = rmse(SimValue,ObsValue),
    r_rmse = rmse(SimValue,ObsValue)/mean(ObsValue)*100, # big precision to enable cretrial of selection
    nse = NSE(SimValue,ObsValue),
    sb = gauchStats(SimValue,ObsValue)[1],
    nu = gauchStats(SimValue,ObsValue)[2],
    lc = gauchStats(SimValue,ObsValue)[3],
    rsr = rsr(SimValue,ObsValue), # Ratio of RMSE to the standard deviation of the ObsValueervations
    pBias = pbias(SimValue,ObsValue)) # Percent Bias between sim and ObsValue, with treatment of missing values.
}
```

Initial criteria of a very good model performance (Moriasi et al 2007 plus some guesses):

This adds beyond the regression based analysis above.

- R2 > 75% (?)
- RMSE of 0 (< 20% is very good?)
- NSE of 1.0 (>0.75 is very good)
- LC = 100% (>80% is very good?)
- Pbias of 0 (< +-0.15 is very good; + is underestimation and - is overestimation)
- RSR of 0 (0 to 0.5 is very good)

There's quite a bit o duplication in these (e.g. pBias and SB are very similar) but we cover well most metrics.


```{r, fig.width=12, results='asis',results='asis', echo=FALSE}
mergedDF %>%
  group_by(VarName) %>%
  doStats()

```

## 3. Sensibility analysis

- Criteria: Are simulated values sensible in relation to real life experiences?

```{r, fig.height = 8, echo=FALSE}

#unique(simData_work$VarName)

simData_work %>%
  ungroup()%>%
  filter(
           VarName == "Soil.SoilWater.Drainage"|
           VarName == "sum.Soil.SoilNitrogen.MineralisedN."|
           VarName == "sum.Soil.SoilNitrogen.Denitrification."|
           VarName == "N_leaching") %>%
  group_by(VarName, Irr, Nit) %>%
  arrange(VarName, Irr, Nit,Clock.Today) %>% 
  mutate(SimValue=cumsum(SimValue)) %>%
  ggplot(aes(x=Clock.Today,y=SimValue)) +
  geom_line(alpha=0.8, aes(colour=Irr,linetype=Nit)) +
  facet_grid(VarName~.,  scales='free')
```


## 4. Sensitivity analysis

- Placeholder for possible sensitivity analysis in APSIM-X
- Which parameters to test?

```{r}

```

