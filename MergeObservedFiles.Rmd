---
title: "R Notebook"
output: html_notebook
---

Inspired by Hamish's beautiful Python script

```{r}
library(readxl)
library(lubridate)
library(dplyr) # data analysis
library(ggplot2)
library(lubridate) # taking care of dates
library(xlsx)

```

```{r}

labelNames <- read.table("C:/GitHubRepos/2017_FodderBeetOats/FodderBeatOats/labels.txt", header=TRUE)

pathMaster <- "C:/GitHubRepos/2017_FodderBeetOats/FodderBeatOats" # where master observed data stays

pathObs <- "C:/GitHubRepos/2017_FodderBeetOats/FodderBeatOats/Observed" # where child observed data stays
```

## Which files where found?
```{r}
obs.files <- list.files(pathObs,pattern="\\.xlsx$", full.names=FALSE) # if true gets path
obs.files
```


```{r}

for (i in 1:length(obs.files)) {

# add a TRYCATCH here that continues the look in the case file does not comply with 
# sheet name or columns name
  
this.obs.file <- read_xlsx(paste0(pathObs,"/",obs.files[i]), sheet = "OBS", col_names = TRUE)  

this.obs.file$SimulationName <- factor(this.obs.file$SimulationName)
this.obs.file$Clock.Today <- ymd(this.obs.file$Clock.Today)

#print(head(this.obs.file))

  if(i==1) {
  
  obs.master <- data.frame()
  obs.master <- this.obs.file
  
  } else {
  
  # Two compulsory fields are "SimulationName" and "Clock.Today"
  obs.master <- merge(obs.master,this.obs.file, by=c("SimulationName","Clock.Today"), all=TRUE)
  
  }

}

summary(obs.master)
```
## Save

As single xlsx observed file

```{r}

#str(obs.master)
#str(labelNames)

#df1 <- merge(obs.master,labelNames, by="SimulationName")

#df2 <- df1 %>%
 df <- obs.master %>%
  mutate(Clock.Today=as.character(as.Date(Clock.Today, "%Y-%m-%d"))) %>%
 #  mutate(Clock.Today=as.Date(Clock.Today, "%Y-%m-%d")) %>%
  arrange(Clock.Today) %>%
  as.data.frame()

# make NAs blank spaces FIXME: corrups format
#df[is.na(df)] <- ""

#colnames(df)[2] <- "Clock.Today()"

summary(df)
```
For the git repo in local
```{r}
pathMaster <- "C:/GitHubRepos/2017_FodderBeetOats/FodderBeatOats"  

write.xlsx(df,paste0(pathMaster,"/Observed.xlsx"), sheetName="OBS", row.names = FALSE, showNA=FALSE) 
```

For sharing with others via K drive
```{r}
# FIXME: Find a better solution for sharing this file
pathFolderWork <- "K:/Rainshelter/Fodderbeet 2016-2017/Analysis" # FIXME: Send to powerPlant or need to run APSIM-X there?

write.xlsx(df,paste0(pathFolderWork,"/Observed.xlsx"), sheetName="OBS", row.names = FALSE, showNA=FALSE)
```

